<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>AJC High school Football Scoreboard</title>
<base target="_parent" />
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="http://host.coxmediagroup.com/ajc/digitalprojects/global/css/iFrame_Medley.css" type="text/css"/>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="http://alt.coxnewsweb.com/ajc/_newsapps/libraries/css/gumby/css/gumby.css" type="text/css"/>
<script src="http://alt.coxnewsweb.com/ajc/_newsapps/libraries/css/gumby/js/libs/modernizr-2.6.2.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.2.2/d3.v3.min.js"></script>
<style type="text/css">
.game {
	margin-top: 10px;
	background-color: #EFEFEF;
	font-size:11px;
}
.team{
	padding-left:4px;
}
.score{
	text-align:right;
	padding-right:4px;
}
hr {
background-color:#FFF;
border-bottom: 1px dashed gray;
border-top:none;
height:0px;
line-height:0;
text-align:center;
margin:0;
}
#chart .game .winner{
	color: red !important;
}
.meta{
	background-color:#E0E0E0;
	font-size:10px;
	line-height:1.5em;
}
.gameStatus{
	text-align:right;
	padding-right:4px;
}
.startTime{
	padding-left:4px;
}
.row{
	min-width:300px;/*Gumby default 320*/
}
#numScores{
	padding:5px 7px;
}
</style>
</head>
<body>
<div class="sixteen colgrid" style="max-width:972px">
<ul class="row">
	<li class="field four columns alpha"><input class="search searchform input" id="searchBox" type="searcg" placeholder="Search for a school"><button id="resetBtn" type="button" class="button">Reset</button></li>
	<li class="field four columns">Results: <span class="input text" id="numScores"> </span></li>
	<li class="four columns omega">Show future games? <input type="checkbox" id="future"/></li>
</ul>
</div>
<div class="sixteen colgrid" style="max-width:972px"><div id="chart" class="row"></div></div>

<script type="text/javascript">
var showFuture = false;
$('#future').prop('checked', false);//handle browser form caching
$("#future").change(function() {
    if(this.checked) {
		showFuture = true;
    }
	else{
		showFuture = false;
	}
	doGrid();
});
$(".searchform").submit(function(){searchGames();})
//var myWidth =  parseFloat(d3.select("body").style("width")) - 20 ;
var data1;
var teamsArr = [];
var filtered = false;
jQuery.getJSON("http://www.scoreatl.com/xml/scoreboard/hs/json/", function(data) {
//jQuery.getJSON("testJSON2.json", function(data) {
	data1 = data.game;
	
	for (var i=0; i<data1.length; i++){
		var awayClass = "";
		var homeClass = "";
		var homeScore = parseInt(data1[i].home.score);
		var awayScore = parseInt(data1[i].away.score);
		var startTime = new Date(data1[i].startTime);
		data1[i].startTime = startTime;
		data1[i].hasStarted = hasStarted(startTime);
		teamsArr.push(data1[i].home.name);
		teamsArr.push(data1[i].away.name);
		if(awayScore > homeScore){
			awayClass = "winner";
		}
		else if(awayScore < homeScore){
			homeClass = "winner";
		}
		data1[i].gameText = "<div class='row team'><div class='fourteen columns "+awayClass+"'><strong>A: </strong>"+data1[i].away.name+"</div><div class='two columns score "+awayClass+"'>"+awayScore+"</div></div><hr><div class='row team'><div class='fourteen columns "+homeClass+"'><strong>H: </strong>"+data1[i].home.name+"</div><div class='two columns score "+homeClass+"'>"+homeScore+"</div></div><div class='row meta'><div class='sixteen columns'><div class='alpha columns startTime'>"+reformatTimestamp(startTime)+"</div><div class='omega columns gameStatus'> "+data1[i].statusText+"</div></div></div>";
	}
	teamsArr = teamsArr.sort();
	doGrid();
});
function doGrid(){	
	var chart = d3.select("#chart").selectAll("div .game");
	buildGrid();
	function buildGrid(){
		$("#searchBox").val(""); //clear any left over searches
		var data2 = checkFuture(data1);
		d3.select("#numScores").text(data2.length);
		var chartTemp = chart.data(data2.sort(function (a, b) {
	    	if (a.away.name > b.away.name){ return 1;}
	    	if (a.away.name < b.away.name){ return -1;}
			// a must be equal to b
			return 0;
		}))
		.enter().append("div")
		.attr("class", "four columns game")
		.html(function(d) { return d.gameText});

		d3.selectAll("div .game").attr("class", function(d, i){
			if(i%4 === 0){ return "alpha four columns game";}//fix left margin with alpha class
			else{return "four columns game"}
		})
	}//buildGrid
	$( "#searchBox" ).autocomplete({
		source: teamsArr,
		select: function( event, ui){
			filtered = true;
			var newdata = data1.filter(function(d) {return d.home.name === ui.item.value | d.away.name === ui.item.value});
			searchGames(newdata);
		}
	})

	$("#resetBtn").click(function(){
		if(filtered){
			d3.selectAll("div .game").remove(); 
			filtered = false; 
			buildGrid(); 
		} 
	})

	function searchGames(newdata){
		d3.select("#numScores").text(newdata.length);
		
		var chart2 = d3.select("#chart").selectAll("div .game")
		.data(newdata, function(d) { return d.home.name });
		
		chart2.enter().append("div")
			.attr("class", "four columns game")
			.html(function(d){ return d.gameText })
		
		d3.transition(chart2.exit())
			.remove();
function setTimeFormat(passedHour) {
	if (passedHour > 0 && passedHour < 13) {
		if (passedHour === "0") passedHour = 12;
		return (passedHour);
	}
	if (passedHour == 0) {
		return (12);
	}
	return (passedHour-12);
}
function showZeroFilled(inValue) {
	if (inValue > 9) {
		return "" + inValue;
	}
	return "0" + inValue;
}
function setAmPm(timestamp) {
	if (timestamp.getHours() < 12) {
		return (" a.m.");
	}
	return (" p.m.");
}
function reformatTimestamp(timestamp) {
	var formattedTime = setTimeFormat(timestamp.getHours()) + ":" + showZeroFilled(timestamp.getMinutes()) + setAmPm(timestamp);
	var formattedYear = (timestamp.getMonth()+1)+"/"+timestamp.getDate()+"/"+(timestamp.getFullYear()+ '').substring(2, 4);//empty string before the substring is to convert to string more efficiently
	return(formattedTime+" "+formattedYear);
}
function checkFuture(stuff){
	if(showFuture){
		return data1;
	}
	else{
		//if the game hasn't started don't show it. Because UTC time counts up we want our start timestamp to be smaller than the current timestamp 
		return(data1.filter(function(d){return d.hasStarted}));
	}
}
function hasStarted(startTime){
	return startTime <= new Date().getTime();
}
</script>
<script>
//New News Apps tracking code
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28102445-5', 'myajc.com');
  ga('send', 'pageview');
</script>
</body>
</html>