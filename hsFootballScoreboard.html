<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>AJC High school Football Scoreboard</title>
<base target="_parent" />
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="http://host.coxmediagroup.com/ajc/digitalprojects/global/css/iFrame_Medley.css" type="text/css"/>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="http://alt.coxnewsweb.com/ajc/_newsapps/libraries/css/gumby/css/gumby.css" type="text/css"/>
<script src="http://alt.coxnewsweb.com/ajc/_newsapps/libraries/css/gumby/js/libs/modernizr-2.6.2.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.2.2/d3.v3.min.js"></script>
<style type="text/css">
#scoreboard{
	max-width:972px;
}
.game {
	margin-top: 10px;
	background-color: #EFEFEF;
	font-size:11px;
}
.team{
	padding-left:4px;
}
.score{
	text-align:right;
	padding-right:4px;
	float:right !important;
}
li.game{
	 padding-bottom: 0px;
}
hr {
background-color:#FFF;
border-bottom: 1px dashed gray;
border-top:none;
height:0px;
line-height:0;
text-align:center;
margin:0;
}
#chart .game .winner{
	color: red !important;
}
.meta{
	background-color:#E0E0E0;
	font-size:10px;
	line-height:1.5em;
}
.tiles li.gameStatus{
	float:right;
	padding-right:4px;
}
.startTime{
	padding-left:4px;
	float:left;
}
.row{
	min-width:300px;/*Gumby default 320*/
}
#numScores{
	padding:5px 7px;
.game .tiles{
	margin:0 !important;
}
.game .tiles li{
	margin:0 !important;
}
#menu{
	font-size:12px;
}
</style>
</head>
<body>
<div id="scoreboard">
<div class="sixteen colgrid" id="menu">
<ul class="row" id="filters">
	<li class="field five columns alpha"><input class="search searchform input" id="searchBox" type="search" placeholder="Search for a school"><button id="resetBtn" type="button" class="button">Reset</button></li>
	<li class="field four columns">Results: <span class="input text" id="numScores"> </span></li>
	<li class="five columns omega" id="futureDiv">Show later games? <input type="checkbox" id="future"/></li>
</ul>
</div>
<div class="row"><ul id="chart" class="tiles three_up"></ul></div>
</div>

<script type="text/javascript">
var showFuture = false;
$(".searchform").submit(function(){searchGames();})
//var myWidth =  parseFloat(d3.select("body").style("width")) - 20 ;
var bodyWidth = $("body").width();
var data1;
var teamsArr = [];
var filtered = false;
jQuery.getJSON("http://www.scoreatl.com/xml/scoreboard/hs/json/", function(data) {
//jQuery.getJSON("testJSON2.json", function(data) {
if(bodyWidth >= 700){
	d3.selectAll("#chart").attr("class", "tiles four_up")
}
else if(bodyWidth >= 600){
	//d3.selectAll("#chart").attr("class", "tiles three_up"); //this is the default
}
else if(bodyWidth >= 500){
	d3.selectAll("#chart").attr("class", "tiles two_up")
}
else{
	d3.selectAll("#chart").attr("class", "tiles_wrap")
}

//jQuery.getJSON("http://www.scoreatl.com/xml/scoreboard/hs/json/", function(data) {
jQuery.getJSON("just1.json", function(data) {
//jQuery.getJSON("testJSON3.json", function(data) {
	data1 = data.game;
	if(data1.length === undefined){
		setProps(data1);
	}
	else{
		for (var i=0; i<data1.length; i++){
			teamsArr.push(data1[i].home.name);//we don't a search menu if there's only one game, so do that here instead of in setProps
			teamsArr.push(data1[i].away.name);
			setProps(data1[i]);	
		}	
	}

	function setProps(game){
		var awayClass = "";
		var homeClass = "";
		var homeScore = parseInt(game.home.score);
		var awayScore = parseInt(game.away.score);
		var startTime = new Date(game.startTime);
		game.startTime = startTime;
		game.hasStarted = hasGameStarted(startTime);
		if(awayScore > homeScore){
			awayClass = "winner";
		}
		else if(awayScore < homeScore){
			homeClass = "winner";
		}
		game.gameText = "<ul class='team row tiles'><li class='"+awayClass+"'><strong>A: </strong>"+game.away.name+"</li><li class='score "+awayClass+"'>"+awayScore+"</li></ul><hr><ul class='team row tiles'><li class='"+homeClass+"'><strong>H: </strong>"+game.home.name+"</li><li class='score "+homeClass+"'>"+homeScore+"</li></ul><ul class='row tiles meta'><li class='startTime'>"+reformatTimestamp(startTime)+"</li><li class='gameStatus'> "+game.statusText+"</li></ul>";
		
	}
	doGrid();
	
	if(data1.length > parseInt($("#numScores").text())){
		$('#future').prop('checked', false);//handle browser form caching
		$("#future").change(function() {
		    if(this.checked) {
				showFuture = true;
		    }
			else{
				showFuture = false;
			}
			doGrid();
		});
	}
	else{
		$("#futureDiv").hide();
	}
});
function doGrid(){
	var chart = d3.select("#chart").selectAll("li.game");
	if(data1.length >1){
		buildGrid();
	}
	else{
		justOne();
	}
	function buildGrid(){
		$("#searchBox").val(""); //clear any left over searches
		teamsArr = teamsArr.sort();
		var data2 = checkFuture(data1);
		d3.select("#numScores").text(data2.length);
		var chartTemp = chart.data(data2.sort(function (a, b) {
	    	if (a.away.name > b.away.name){ return 1;}
	    	if (a.away.name < b.away.name){ return -1;}
			// a must be equal to b
			return 0;
		}))
		.enter().append("div")
		.attr("class", "four columns game")
		.html(function(d) { return d.gameText});
		var tempChart = chart.data(data2, function(d){return d.away.name});
		
		tempChart.exit().remove();
		
		tempChart.enter().append("li")
			.attr("class", "game")
			.html(function(d) { return d.gameText});
	}//buildGrid
	function justOne(){
		$("#filters").hide();
		d3.select("#numScores").text("1");
		$("#chart").append("li")
			.attr("class", "game")
			.html(data1.gameText);
	}
	$("#searchBox").autocomplete({
		source: teamsArr,
		select: function( event, ui){
			filtered = true;
			var newdata = data1.filter(function(d) {return d.home.name === ui.item.value | d.away.name === ui.item.value});
			searchGames(newdata);
		}
	})

	$("#resetBtn").click(function(){
		if(filtered){
			d3.selectAll("li.game").remove(); //get rid of any search items on display
			filtered = false; 
			buildGrid(); 
		} 
	})

	function searchGames(newdata){
		d3.select("#numScores").text(newdata.length);
		
		var chart2 = d3.select("#chart").selectAll("li.game")
			.data(newdata, function(d) {return d.away.name });
		
		chart2.enter().append("li")
			.attr("class", "game")
			.html(function(d){ return d.gameText })
		
		d3.transition(chart2.exit())
			.remove();
	}//searchGames
}//doGrid

function setTimeFormat(passedHour) {
	if (passedHour > 0 && passedHour < 13) {
		if (passedHour === "0") passedHour = 12;
		return (passedHour);
	}
	if (passedHour == 0) {
		return (12);
	}
	return (passedHour-12);
}
function showZeroFilled(inValue) {
	if (inValue > 9) {
		return "" + inValue;
	}
	return "0" + inValue;
}
function setAmPm(timestamp) {
	if (timestamp.getHours() < 12) {
		return (" a.m.");
	}
	return (" p.m.");
}
function reformatTimestamp(timestamp) {
	var formattedTime = setTimeFormat(timestamp.getHours()) + ":" + showZeroFilled(timestamp.getMinutes()) + setAmPm(timestamp);
	var formattedYear = (timestamp.getMonth()+1)+"/"+timestamp.getDate()+"/"+(timestamp.getFullYear()+ '').substring(2, 4);//empty string before the substring is to convert to string more efficiently
	return(formattedTime+" "+formattedYear);
}
function checkFuture(stuff){
	if(showFuture){
		return data1;
	}
	else{
		//if the game hasn't started don't show it. Because UTC time counts up we want our start timestamp to be smaller than the current timestamp 
		return(data1.filter(function(d){return d.hasStarted}));
	}
}
function hasStarted(startTime){
	return startTime <= new Date().getTime();
}
</script>
<script>
//New News Apps tracking code
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28102445-5', 'myajc.com');
  ga('send', 'pageview');
</script>
</body>
</html>